generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DIRECT_URL")
}

model User {
  id                 String              @id @default(cuid())
  email              String              @unique
  password           String?
  firstName          String
  lastName           String
  phone              String?
  address            String?
  dateOfBirth        DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  role               UserRole            @default(USER)
  accountStatus      AccountStatus       @default(PENDING)
  accountType        AccountType         @default(INDIVIDUAL)
  account            Account?
  auditLogs          AuditLog[]
  kycDocuments       KYCDocument[]
  notifications      Notification[]
  references         Reference[]
  selfieVerification SelfieVerification?
  verificationStatus VerificationStatus?
  dojahVerifications DojahVerification[]
  adminReviews       AdminReview[]
  reviewedByMe       AdminReview[]       @relation("AdminReviews")
}

model Account {
  id              String        @id @default(cuid())
  userId          String        @unique
  businessName    String?
  businessType    BusinessType?
  businessAddress String?
  taxNumber       String?
  scumlNumber     String?
  occupation      String?
  sourceOfIncome  String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model KYCDocument {
  id          String                 @id @default(cuid())
  userId      String
  type        DocumentType
  fileContent String?
  fileSize    Int
  mimeType    String
  fileName    String
  isChunked   Boolean                @default(false)
  uploadedAt  DateTime               @default(now())
  verified    Boolean                @default(false)
  verifiedAt  DateTime?
  verifiedBy  String?
  status      VerificationStatusEnum @default(PENDING)
  notes       String?
  FileChunk   FileChunk[]
  user        User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  documentAnalysis DocumentAnalysis?
}

model SelfieVerification {
  id          String                 @id @default(cuid())
  userId      String                 @unique
  fileContent String?
  fileName    String
  fileSize    Int
  mimeType    String
  isChunked   Boolean                @default(false)
  capturedAt  DateTime               @default(now())
  verified    Boolean                @default(false)
  verifiedAt  DateTime?
  verifiedBy  String?
  status      VerificationStatusEnum @default(PENDING)
  notes       String?
  FileChunk   FileChunk[]
  user        User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationStatus {
  id            String                 @id @default(cuid())
  userId        String                 @unique
  kycStatus     VerificationStatusEnum @default(PENDING)
  selfieStatus  VerificationStatusEnum @default(PENDING)
  overallStatus VerificationStatusEnum @default(PENDING)
  progress      Int                    @default(0)
  updatedAt     DateTime               @updatedAt
  reviewedBy    String?
  notes         String?
  user          User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Reference {
  id           String    @id @default(cuid())
  userId       String
  name         String
  address      String
  phone        String
  email        String?
  relationship String?
  verified     Boolean   @default(false)
  verifiedAt   DateTime?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  title     String
  message   String
  type      NotificationType
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  link      String?
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  details    String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  targetId   String?
  targetType String?
  user       User     @relation(fields: [userId], references: [id])
}

model SystemSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   String?
}

model FileChunk {
  id                   String              @id @default(cuid())
  fileId               String
  chunkIndex           Int
  content              String
  kycDocumentId        String?
  selfieVerificationId String?
  kycDocument          KYCDocument?        @relation(fields: [kycDocumentId], references: [id], onDelete: Cascade)
  selfieVerification   SelfieVerification? @relation(fields: [selfieVerificationId], references: [id], onDelete: Cascade)

  @@unique([fileId, chunkIndex])
}

model DojahVerification {
  id                String                @id @default(cuid())
  userId            String
  verificationType  DojahVerificationType
  documentId        String?               // References KYCDocument or SelfieVerification
  referenceId       String?               // Dojah's reference ID
  requestData       Json?                 // Original request payload
  responseData      Json?                 // Dojah response
  status            DojahStatus           @default(PENDING)
  confidence        Float?                // Confidence score from Dojah
  matchResult       Json?                 // Face match or document match results
  extractedData     Json?                 // Extracted data from document analysis
  governmentData    Json?                 // Data from government lookup APIs
  errorMessage      String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  user              User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  adminReviews      AdminReview[]
  
  @@index([userId, verificationType])
  @@index([referenceId])
}

model DocumentAnalysis {
  id               String    @id @default(cuid())
  kycDocumentId    String    @unique
  extractedText    String?
  extractedData    Json?     // Structured data extracted from document
  documentType     String?   // Detected document type
  confidence       Float?    // Analysis confidence score
  isReadable       Boolean   @default(false)
  qualityScore     Float?    // Document quality score
  analysisProvider String    @default("DOJAH")
  createdAt        DateTime  @default(now())
  kycDocument      KYCDocument @relation(fields: [kycDocumentId], references: [id], onDelete: Cascade)
}

model AdminReview {
  id                String                @id @default(cuid())
  userId            String
  reviewerId        String
  documentId        String?               // KYCDocument or SelfieVerification ID
  verificationType  AdminReviewType
  dojahVerificationId String?
  status            AdminReviewStatus     @default(PENDING)
  reviewNotes       String?
  rejectionReason   String?
  allowReupload     Boolean               @default(false)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  user              User                  @relation(fields: [userId], references: [id])
  reviewer          User                  @relation("AdminReviews", fields: [reviewerId], references: [id])
  dojahVerification DojahVerification?    @relation(fields: [dojahVerificationId], references: [id])
  
  @@index([userId])
  @@index([reviewerId])
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum AccountStatus {
  PENDING
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum AccountType {
  INDIVIDUAL
  PARTNERSHIP
  ENTERPRISE
  LLC
}

enum BusinessType {
  SOLE_PROPRIETORSHIP
  PARTNERSHIP
  LLC
  CORPORATION
}

enum DocumentType {
  ID_CARD
  PASSPORT
  UTILITY_BILL
  CERTIFICATE_OF_REGISTRATION
  FORM_OF_APPLICATION
  VALID_ID_OF_PARTNERS
  PROOF_OF_ADDRESS
  CERTIFICATE_OF_INCORPORATION
  MEMORANDUM_ARTICLES
  BOARD_RESOLUTION
  DIRECTORS_ID
  PASSPORT_PHOTOS
  UTILITY_RECEIPT
  BUSINESS_OWNER_ID
  BVN_SLIP
  NIN_SLIP
  DRIVERS_LICENSE
  VOTERS_CARD
}

enum VerificationStatusEnum {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
  REQUIRES_REUPLOAD
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum DojahVerificationType {
  BVN_LOOKUP
  NIN_LOOKUP
  PASSPORT_LOOKUP
  DRIVERS_LICENSE_LOOKUP
  DOCUMENT_ANALYSIS
  SELFIE_PHOTO_ID_MATCH
  LIVENESS_CHECK
  AML_SCREENING
}

enum DojahStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
  INCOMPLETE_DATA
  RETRY_REQUIRED
}

enum AdminReviewType {
  DOCUMENT_VERIFICATION
  SELFIE_VERIFICATION
  IDENTITY_VERIFICATION
  FINAL_APPROVAL
}

enum AdminReviewStatus {
  PENDING
  APPROVED
  REJECTED
  REQUIRES_ADDITIONAL_INFO
}
